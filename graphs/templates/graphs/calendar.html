<figure id="heatmap-window" data-days='{{ day_data|safe }}'></figure>
<script>
(function() {
  // 1. CONFIGURATION
  const cellSize = 50; 
  const gap = 4;
  const container = d3.select("#heatmap-window");
  
  // State: Start with the Sunday of the current week
  let viewStart = d3.timeWeek.floor(new Date());

  // Grab the raw JSON from the figure attribute
  const rawData = JSON.parse(container.attr("data-days"));

  // Create a Map for O(1) lookup: "2025-12-22" -> {id: 1, ratio: 0.85, ...}
  const dataMap = new Map(rawData.map(d => [d.date, d]));

  // Create a color scale (Greens)
  // 0.0 = light/empty, 1.0 = full green, >1.0 = deep green
  const colorScale = d3.scaleSequential(d3.interpolateGreens).domain([0, 1.2]);

  // 2. RENDER FUNCTION
  function renderWindow(startDate) {
    // Calculate the 14-day range
    const endDate = d3.timeDay.offset(startDate, 14);
    const days = d3.timeDays(startDate, endDate);
    
    // Update Header Text
    const format = d3.timeFormat("%b %d");
    d3.select("#current-range").text(`${format(startDate)} â€” ${format(d3.timeDay.offset(endDate, -1))}`);

    // Create/Select SVG
    let svg = container.selectAll("svg").data([null]);
    svg = svg.enter().append("svg")
      .attr("width", (cellSize + gap) * 7) // 7 days per row
      .attr("height", (cellSize + gap) * 2) // 2 weeks
      .merge(svg);

    // BIND DATA
const cells = svg.selectAll("rect").data(days, d => d.getTime());

// 1. EXIT: Remove old days
cells.exit().remove();

// 2. ENTER: Create new elements (and their titles)
const cellsEnter = cells.enter()
  .append("rect")
  .attr("width", cellSize)
  .attr("height", cellSize)
  .attr("rx", 4);

// Append the title tag ONLY ONCE when the rect is created
cellsEnter.append("title");

// 3. MERGE: Update all rects (new and existing)
const cellsMerge = cellsEnter.merge(cells);

// Update the title text every time the window slides
cellsMerge.select("title")
  .text(d => {
    const dateStr = d3.timeFormat("%Y-%m-%d")(d);
    const dayData = dataMap.get(dateStr);
    return dayData 
      ? `Date: ${dateStr}\nRatio: ${dayData.ratio}` 
      : `Date: ${dateStr}\nNo data`;
  });

cellsMerge
  .on("click", (event, d) => {
    const dateStr = d3.timeFormat("%Y-%m-%d")(d);
    const dayData = dataMap.get(dateStr);
    if (dayData) {
        setSelectedDate(dayData.date);
        htmx.ajax('GET', `/day/${dayData.date}`, {target: '#day-container'});
    }
  });

// 4. TRANSITION: Handle visual changes separately
cellsMerge.transition().duration(400)
  .attr("x", (d, i) => (i % 7) * (cellSize + gap))
  .attr("y", (d, i) => Math.floor(i / 7) * (cellSize + gap))
  .attr("fill", d => {
    const dateStr = d3.timeFormat("%Y-%m-%d")(d);
    const dayData = dataMap.get(dateStr);
    const isToday = d3.timeDay.floor(new Date()).getTime() === d.getTime();

    if (isToday) return "#2060DF"; 
    if (!dayData) return "#0F1114"; 
    
    return colorScale(dayData.ratio);
  });

      }

  // 3. NAVIGATION LOGIC
  d3.select("#prev").on("click", () => {
    viewStart = d3.timeDay.offset(viewStart, -7);
    renderWindow(viewStart);
  });

  d3.select("#next").on("click", () => {
    viewStart = d3.timeDay.offset(viewStart, 7);
    renderWindow(viewStart);
  });

  // Initial Render
  renderWindow(viewStart);
})();
</script>

<style>
  #heatmap-window {
    display: flex;
    justify-content: center;
    margin-top: 20px;
  }
  rect {
    stroke: rgba(0,0,0,0.05);
    cursor: pointer;
  }
  rect:hover {
    stroke: #000;
  }
</style>
