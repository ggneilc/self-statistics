
<div id="d3-line" data-days='{{ day_data|safe }}'></div>

<div id="stats" class="container summary">
  {{ summary }}
</div>

<script>
(function() {
    const container = document.getElementById("d3-line");
    if (!container) return;

    let data;
    try {
        data = JSON.parse(container.dataset.days);
    } catch (err) {
        console.error("Invalid day data:", err);
        return;
    }

    data = data.map(d => ({
        date: new Date(d.day),
        value: +d.value,
        ma7: +d.ma7
    })).sort((a, b) => a.date - b.date);

    container.innerHTML = "";

    // 1. Fixed internal dimensions (viewBox) â€” SVG scales to container
    const margin = { top: 20, right: 30, bottom: 40, left: 50 };
    const baseWidth = 1000;
    const baseHeight = 350;

    // 2. Create Scales based on baseWidth/baseHeight
    const x = d3.scaleTime()
        .domain(d3.extent(data, d => d.date))
        .range([margin.left, baseWidth - margin.right]);

    const y = d3.scaleLinear()
        .domain([d3.min(data, d => d.value) - 1, d3.max(data, d => d.value) + 1])
        .nice()
        .range([baseHeight - margin.bottom, margin.top]);

    // 3. Responsive SVG: viewBox defines coordinate system; scales to container
    const svg = d3.select(container)
        .append("svg")
        .attr("viewBox", `0 0 ${baseWidth} ${baseHeight}`)
        .attr("preserveAspectRatio", "xMidYMid meet")
        .style("width", "100%")
        .style("height", "100%");

    const g = svg.append("g");

    // 4. Draw Axes
    g.append("g")
        .attr("transform", `translate(0,${baseHeight - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(baseWidth / 100).tickFormat(d3.timeFormat("%b %d")))
        .selectAll("text")
        .style("font-size", "14px") // Fixed internal font size
        .style("fill", "var(--text, #f5f5f5)");

    g.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y).ticks(5))
        .selectAll("text")
        .style("font-size", "14px")
        .style("fill", "var(--text, #f5f5f5)");

    // 5. Line Generators
    const line = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.value))
        .curve(d3.curveMonotoneX);

    const maline = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.ma7))
        .curve(d3.curveBasis);

    // 6. Draw Paths
    // Raw Weight Line
    svg.append("path")
        .datum(data)
        .attr("fill", "none")
        .attr("stroke", "var(--accent, #ffc83d)")
        .attr("stroke-width", 3)
        .attr("d", line);

    // Moving Average Line (Animated)
    const maPath = svg.append("path")
        .datum(data)
        .attr("fill", "none")
        .attr("stroke", "var(--pico-secondary, #707a8a)")
        .attr("stroke-width", 3)
        .attr("d", maline);

    const totalLength = maPath.node().getTotalLength();

    maPath
        .attr("stroke-dasharray", totalLength + " " + totalLength)
        .attr("stroke-dashoffset", totalLength)
        .transition()
        .duration(2000)
        .ease(d3.easeLinear)
        .attr("stroke-dashoffset", 0);

    // 7. Draw Points
    svg.selectAll(".dot")
        .data(data)
        .enter()
        .append("circle")
        .attr("class", "dot")
        .attr("cx", d => x(d.date))
        .attr("cy", d => y(d.value))
        .attr("fill", "var(--accent, #ffc83d)")
        .transition()
        .delay((d, i) => i * 30)
        .duration(500)
        .attr("r", 5);
})();
</script>